#!/usr/bin/env node
import{pipeline as $dj3tT$pipeline,PassThrough as $dj3tT$PassThrough}from"stream";import $dj3tT$yargs from"yargs";import{filename}from"dirname-filename-esm";import $dj3tT$assert from"assert";import{fork as $dj3tT$fork,ChildProcess as $dj3tT$ChildProcess}from"child_process";import{resolve as $dj3tT$resolve,dirname as $dj3tT$dirname1}from"path";import{dirname as $dj3tT$dirname}from"dirname-filename-esm";import{isDeepStrictEqual as $dj3tT$isDeepStrictEqual}from"util";import $dj3tT$events from"events";import $dj3tT$fspromises from"fs/promises";import{exit as $dj3tT$exit,env as $dj3tT$env}from"process";import{mergeDeepRight as $dj3tT$mergeDeepRight}from"ramda";import $dj3tT$yaml from"yaml";import{scheduler as $dj3tT$scheduler}from"timers/promises";var $2aa6c092a9125146$exports={};$2aa6c092a9125146$exports=JSON.parse('{"name":"tap-ogg","type":"module","license":"MIT","repository":"github:marek629/tap-nyan-ogg","keywords":["test","testing","tap","cli","ava","ogg","nyan"],"version":"0.5.0","engines":{"node":">= 12"},"targets":{"main":{"isLibrary":true,"source":"build/src/cli.js","outputFormat":"esmodule"},"play":{"isLibrary":true,"source":"build/src/audio/play.js","distDir":"dist/audio","outputFormat":"esmodule"}},"files":["CHANGELOG.md","dist/*"],"main":"dist/cli.js","bin":{"tap-ogg":"dist/cli.js"},"scripts":{"prebuild":"rm -rf build dist && yarn pretest","build":"parcel build --no-source-maps","postbuild":"bash -xe tools/postbuild.sh","coverage":"bash -xe tools/coverage.sh","start":"yarn ava --tap | dist/cli.js","pretest":"bash -xe tools/pretest.sh","test":"yarn test:unit && yarn test:integration","test:unit":"ava","test:integration":"bats test/*.bats --timing --trace --print-output-on-failure","test:tap":"cat <(yarn test:unit --tap) <(yarn test:integration --tap) | ../node_modules/tap-merge/cli.js | dist/cli.js --silence","verify":"bash -xe tools/verify.sh","prepack":"rm -f dist/*.yml","postpack":"tar tf tap-ogg-v*.tgz","preversion":"yarn verify","postversion":"yarn pack"},"ava":{"files":["build/test/**/*.test.js","!**/(massive|passing|skipping).*"],"nodeArguments":["--experimental-specifier-resolution=node"]},"c8":{"all":true,"src":"build/src","exclude":["submodule/**","**/*.test.js"],"reporter":["html","lcov","text-summary"]},"dependencies":{"@datastructures-js/queue":"^4.2.3","@suldashi/ogg":"^1.2.9","@tap-ogg/tap-nyan":"^1.2.0","@tap-ogg/vorbis":"^0.3.0","debouncing":"^22.7.24","dirname-filename-esm":"^1.1.1","event-stream":"^4.0.1","ramda":"^0.29.1","speaker":"^0.5.3","tap-merge":"^0.3.1","yaml":"^2.3.0","yargs":"^17.7.2"},"devDependencies":{"@ava/typescript":"^4.0.0","@types/node":"^20.8.7","@types/ramda":"^0.29.7","@types/sinon":"^10.0.13","@types/yargs":"^17.0.24","ava":"^5.2.0","bats":"^1.5.0","c8":"^7.13.0","dependency-cruiser":"^12.7.0","parcel":"^2.8.0","prettier":"^2.8.4","resolve":"^1.22.1","sinon":"^15.0.1","terser":"^5.17.6","typescript":"^4.8.4"}}');const $0d5ddd1519aefed6$export$8c2dc7716bef61cc=obj=>Object.entries(Object.getOwnPropertyDescriptors(obj.__proto__)).filter((([name,item])=>typeof item.get==="function")).map((([name])=>name));const $755bef5bcb8e43db$var$sendObserverState=(observer,audio)=>audio.send({kind:"tap-stream-observer-state",value:JSON.stringify(observer,(0,$0d5ddd1519aefed6$export$8c2dc7716bef61cc)(observer))});const $755bef5bcb8e43db$export$7310cf3e5a42929c=(observer,audio)=>{$755bef5bcb8e43db$var$sendObserverState(observer,audio);observer.on("changed",(()=>$755bef5bcb8e43db$var$sendObserverState(observer,audio)))};var $60bddf0cac91bcea$import_meta=Object.assign(Object.create(null),{url:"file:///tap-ogg/build/src/audio/AudioPlayer.js"});class $60bddf0cac91bcea$export$832cc5475f11d8b4{#process;constructor(filePath,volume,abortSignal){if(!Number.isSafeInteger(volume))return;const paths=[(0,$dj3tT$dirname)($60bddf0cac91bcea$import_meta)];if(!paths[0].endsWith("/audio"))paths.push("audio");paths.push("play.js");this.#process=(0,$dj3tT$fork)((0,$dj3tT$resolve)(...paths),[filePath,`${volume}`],{env:{...process.env,isAudioProcess:"true"},signal:abortSignal});this.#process.on("error",this.onError)}onError(err){const{code:code}=err;if(code!=="ABORT_ERR")console.error(err);if(code==="ENOENT")process.exit(8)}connect(observer){(0,$dj3tT$assert)(this.#process instanceof(0,$dj3tT$ChildProcess),`${this.#process} process should be ChildProcess instance`);(0,$755bef5bcb8e43db$export$7310cf3e5a42929c)(observer,this.#process)}}const $f350b95923ccbdb1$export$842c7f1d8282385d=Object.seal({exit:$dj3tT$exit,readFile:(0,$dj3tT$fspromises).readFile});const $f350b95923ccbdb1$var$defaultSettings=Object.freeze({effect:{echo:{enabled:true,size:8e3,gain:.85},tremolo:{enabled:true,lfo:{frequency:33,sampling:8e3}}}});const $f350b95923ccbdb1$export$b99b6f6e38298768=new(0,$dj3tT$events);const $f350b95923ccbdb1$var$watchFile=async()=>{const{configFilePath:configFilePath}=(0,$dj3tT$env);if(!configFilePath){console.error("wrong path from process:",process.argv);return}for await(const{filename:filename}of(0,$dj3tT$fspromises).watch((0,$dj3tT$dirname1)(configFilePath)))if(filename===configFilePath)$f350b95923ccbdb1$export$b99b6f6e38298768.emit("change")};if((0,$dj3tT$env).isAudioProcess)$f350b95923ccbdb1$var$watchFile();const $f350b95923ccbdb1$export$72c04af63de9061a=async()=>{const{configFilePath:configFilePath}=(0,$dj3tT$env);const{exit:exit,readFile:readFile}=$f350b95923ccbdb1$export$842c7f1d8282385d;try{const code=await readFile(configFilePath,"utf-8");if(code.trim()==="")return{};return(0,$dj3tT$yaml).parse(code)}catch(e){if(e.code!=="ENOENT"){console.error(e);exit(4)}return{}}};const $f350b95923ccbdb1$export$f2283db29a78ea0=async(file,state)=>(0,$dj3tT$mergeDeepRight)((0,$dj3tT$mergeDeepRight)($f350b95923ccbdb1$var$defaultSettings,await file()),state());const $f350b95923ccbdb1$export$a91807c918b9332e=()=>(0,$dj3tT$yaml).stringify($f350b95923ccbdb1$var$defaultSettings);const $d4f22d83f6d229a9$var$store={format:{sampleRate:44100}};const $d4f22d83f6d229a9$export$825f8f0ad33951e4=state=>{for(const key in state)$d4f22d83f6d229a9$var$store[key]=state[key]};const $d4f22d83f6d229a9$export$50fdfeece43146fd=()=>$d4f22d83f6d229a9$var$store;const $b46271c7a3404655$var$deliverConfiguration=()=>(0,$f350b95923ccbdb1$export$f2283db29a78ea0)((0,$f350b95923ccbdb1$export$72c04af63de9061a),(0,$d4f22d83f6d229a9$export$50fdfeece43146fd));const $b46271c7a3404655$export$842c7f1d8282385d={deliverConfiguration:$b46271c7a3404655$var$deliverConfiguration};const $b46271c7a3404655$var$cache=Object.seal({input:new Map,result:new Map});const $b46271c7a3404655$export$25a7e7a5abf9696a=async(name,selector,factory)=>{const{deliverConfiguration:deliverConfiguration}=$b46271c7a3404655$export$842c7f1d8282385d;const config=await deliverConfiguration();const data=selector(config);if($b46271c7a3404655$var$cache.input.has(name)&&(0,$dj3tT$isDeepStrictEqual)(data,$b46271c7a3404655$var$cache.input.get(name)))return $b46271c7a3404655$var$cache.result.get(name);const value=factory(data);$b46271c7a3404655$var$cache.input.set(name,data);$b46271c7a3404655$var$cache.result.set(name,value);return value};const $b46271c7a3404655$export$d2adf65b87e47523=()=>{for(const key in $b46271c7a3404655$var$cache){const map=$b46271c7a3404655$var$cache[key];map.clear()}};const $7314279b5fcbd88b$export$f416f9931619449a=Object.freeze({isValid:true});class $7314279b5fcbd88b$export$44abddc3fd19288a extends(0,$dj3tT$PassThrough){#errorOccured=false;#errorRegex=/^\s*not ok \d+ - /im;#endRegex=/^\d+\.\.\d+$/im;#buffer="";constructor(options={}){super(options)}get isValid(){return!this.#errorOccured}_transform(chunk,encoding,callback){const str=this._string(chunk);if(str.trim().length>0)this.emit("start");if(this.#errorRegex.test(str)){const oldFlag=this.#errorOccured;this.#errorOccured=true;if(this.#errorOccured!==oldFlag)this.emit("changed")}if(this.#endRegex.test(str))this.emit("end");super._transform(chunk,encoding,callback)}_string(chunk){const str=chunk.toString();const lastBreakLineIndex=str.lastIndexOf("\n");if(lastBreakLineIndex>=0){const lines=this.#buffer+str.slice(0,lastBreakLineIndex);this.#buffer=str.slice(lastBreakLineIndex);return lines}return this.#buffer+=str.slice(0)}}const $3224aff4755f5c4b$export$7fd8d6ddb97d29fd=(emitter,event,timeout)=>{const positive=new Promise((resolve=>{emitter.once(event,resolve)}));const negative=(0,$dj3tT$scheduler).wait(timeout).then((()=>Promise.reject(new Error(`Timed out waiting for "${event}" event.`))));return Promise.race([positive,negative])};const{argv:$7c10295496fc3dd7$var$argv}=(0,$dj3tT$yargs)(process.argv.slice(2)).version((0,$2aa6c092a9125146$exports.version)).locale("en").option("defaults",{alias:"d",demandOption:false,describe:"Print default configuration values",boolean:true,nargs:0}).option("config",{alias:"c",demandOption:false,describe:"YAML configuration file path",string:"true",nargs:1,default:"config.yml"}).option("audio",{alias:"a",demandOption:false,describe:"Sound file path. Default is nyan cat song.",string:true,nargs:1}).option("silence",{alias:"s",demandOption:false,describe:"Do not play any sound.",boolean:true,nargs:0}).option("volume",{alias:"v",demandOption:false,describe:"Set percent value of sound volume in range [0-100]",number:true,nargs:1,default:100});const $7c10295496fc3dd7$var$volume=parseInt($7c10295496fc3dd7$var$argv.volume,10);if($7c10295496fc3dd7$var$volume<0||$7c10295496fc3dd7$var$volume>100){console.error(`Volume should be in range 0-100. Given value was ${$7c10295496fc3dd7$var$volume}.`);process.exit(2)}if($7c10295496fc3dd7$var$argv.defaults){console.log((0,$f350b95923ccbdb1$export$a91807c918b9332e)());process.exit(0)}const $7c10295496fc3dd7$var$observer=new(0,$7314279b5fcbd88b$export$44abddc3fd19288a);(0,$dj3tT$pipeline)([process.stdin,$7c10295496fc3dd7$var$observer,process.stdout],(()=>{}));try{await(0,$3224aff4755f5c4b$export$7fd8d6ddb97d29fd)($7c10295496fc3dd7$var$observer,"start",165)}catch(r){console.error("Empty input stream! A text stream formatted according to the Test Anything Protocol was expected.");process.exit(5)}const $7c10295496fc3dd7$var$controller=new AbortController;$7c10295496fc3dd7$var$observer.once("end",(()=>{$7c10295496fc3dd7$var$controller.abort();process.exit(0)}));if(!$7c10295496fc3dd7$var$argv.silence&&$7c10295496fc3dd7$var$volume>0){process.env.configFilePath=$7c10295496fc3dd7$var$argv.config;const player=new(0,$60bddf0cac91bcea$export$832cc5475f11d8b4)($7c10295496fc3dd7$var$argv.audio,$7c10295496fc3dd7$var$volume,$7c10295496fc3dd7$var$controller.signal);player.connect($7c10295496fc3dd7$var$observer)}