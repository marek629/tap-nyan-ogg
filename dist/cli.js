#!/usr/bin/env node
import{pipeline as $7VbkM$pipeline,PassThrough as $7VbkM$PassThrough}from"stream";import $7VbkM$yargs from"yargs";import{filename}from"dirname-filename-esm";import $7VbkM$assert from"assert";import{fork as $7VbkM$fork,ChildProcess as $7VbkM$ChildProcess}from"child_process";import{resolve as $7VbkM$resolve,dirname as $7VbkM$dirname1}from"path";import{dirname as $7VbkM$dirname}from"dirname-filename-esm";import{isDeepStrictEqual as $7VbkM$isDeepStrictEqual}from"util";import $7VbkM$events from"events";import $7VbkM$fspromises from"fs/promises";import{exit as $7VbkM$exit,env as $7VbkM$env}from"process";import{mergeDeepRight as $7VbkM$mergeDeepRight}from"ramda";import $7VbkM$yaml from"yaml";import{scheduler as $7VbkM$scheduler}from"timers/promises";const $e1676ca97a562b8b$export$8c2dc7716bef61cc=obj=>Object.entries(Object.getOwnPropertyDescriptors(obj.__proto__)).filter((([name,item])=>typeof item.get==="function")).map((([name])=>name));const $ab33a6f8be937191$var$sendObserverState=(observer,audio)=>audio.send({kind:"tap-stream-observer-state",value:JSON.stringify(observer,(0,$e1676ca97a562b8b$export$8c2dc7716bef61cc)(observer))});const $ab33a6f8be937191$export$7310cf3e5a42929c=(observer,audio)=>{$ab33a6f8be937191$var$sendObserverState(observer,audio);observer.on("changed",(()=>$ab33a6f8be937191$var$sendObserverState(observer,audio)))};var $989b25cd83d9aade$import_meta=Object.assign(Object.create(null),{url:"file://"+filename(import.meta)});class $989b25cd83d9aade$export$832cc5475f11d8b4{#process;constructor(filePath,volume,abortSignal){if(!Number.isSafeInteger(volume))return;const paths=[(0,$7VbkM$dirname)($989b25cd83d9aade$import_meta)];if(!paths[0].endsWith("/audio"))paths.push("audio");paths.push("play.js");this.#process=(0,$7VbkM$fork)((0,$7VbkM$resolve)(...paths),[filePath,`${volume}`],{env:{...process.env,isAudioProcess:"true"},signal:abortSignal});this.#process.on("error",this.onError)}onError(err){const{code:code}=err;if(code!=="ABORT_ERR")console.error(err);if(code==="ENOENT")process.exit(8)}connect(observer){(0,$7VbkM$assert)(this.#process instanceof(0,$7VbkM$ChildProcess),`${this.#process} process should be ChildProcess instance`);(0,$ab33a6f8be937191$export$7310cf3e5a42929c)(observer,this.#process)}}const $b5f246dd37abe703$export$842c7f1d8282385d=Object.seal({exit:$7VbkM$exit,readFile:(0,$7VbkM$fspromises).readFile});const $b5f246dd37abe703$var$defaultSettings=Object.freeze({effect:{echo:{enabled:true,size:8e3,gain:.85},tremolo:{enabled:true,lfo:{frequency:33,sampling:8e3}}}});const $b5f246dd37abe703$export$b99b6f6e38298768=new(0,$7VbkM$events);const $b5f246dd37abe703$var$watchFile=async()=>{const{configFilePath:configFilePath}=(0,$7VbkM$env);if(!configFilePath){console.error("wrong path from process:",process.argv);return}for await(const{filename:filename}of(0,$7VbkM$fspromises).watch((0,$7VbkM$dirname1)(configFilePath)))if(filename===configFilePath)$b5f246dd37abe703$export$b99b6f6e38298768.emit("change")};if((0,$7VbkM$env).isAudioProcess)$b5f246dd37abe703$var$watchFile();const $b5f246dd37abe703$export$72c04af63de9061a=async()=>{const{configFilePath:configFilePath}=(0,$7VbkM$env);const{exit:exit,readFile:readFile}=$b5f246dd37abe703$export$842c7f1d8282385d;try{const code=await readFile(configFilePath,"utf-8");if(code.trim()==="")return{};return(0,$7VbkM$yaml).parse(code)}catch(e){if(e.code!=="ENOENT"){console.error(e);exit(4)}return{}}};const $b5f246dd37abe703$export$f2283db29a78ea0=async(file,state)=>(0,$7VbkM$mergeDeepRight)((0,$7VbkM$mergeDeepRight)($b5f246dd37abe703$var$defaultSettings,await file()),state());const $b5f246dd37abe703$export$a91807c918b9332e=()=>(0,$7VbkM$yaml).stringify($b5f246dd37abe703$var$defaultSettings);const $5c6fcfd5b50ea5d0$var$store={format:{sampleRate:44100}};const $5c6fcfd5b50ea5d0$export$825f8f0ad33951e4=state=>{for(const key in state)$5c6fcfd5b50ea5d0$var$store[key]=state[key]};const $5c6fcfd5b50ea5d0$export$50fdfeece43146fd=()=>$5c6fcfd5b50ea5d0$var$store;const $f9dfcc1caef9a121$var$deliverConfiguration=()=>(0,$b5f246dd37abe703$export$f2283db29a78ea0)((0,$b5f246dd37abe703$export$72c04af63de9061a),(0,$5c6fcfd5b50ea5d0$export$50fdfeece43146fd));const $f9dfcc1caef9a121$export$842c7f1d8282385d={deliverConfiguration:$f9dfcc1caef9a121$var$deliverConfiguration};const $f9dfcc1caef9a121$var$cache=Object.seal({input:new Map,result:new Map});const $f9dfcc1caef9a121$export$25a7e7a5abf9696a=async(name,selector,factory)=>{const{deliverConfiguration:deliverConfiguration}=$f9dfcc1caef9a121$export$842c7f1d8282385d;const config=await deliverConfiguration();const data=selector(config);if($f9dfcc1caef9a121$var$cache.input.has(name)&&(0,$7VbkM$isDeepStrictEqual)(data,$f9dfcc1caef9a121$var$cache.input.get(name)))return $f9dfcc1caef9a121$var$cache.result.get(name);const value=factory(data);$f9dfcc1caef9a121$var$cache.input.set(name,data);$f9dfcc1caef9a121$var$cache.result.set(name,value);return value};const $f9dfcc1caef9a121$export$d2adf65b87e47523=()=>{for(const key in $f9dfcc1caef9a121$var$cache){const map=$f9dfcc1caef9a121$var$cache[key];map.clear()}};const $ca37bfd0324037b5$export$f416f9931619449a=Object.freeze({isValid:true});class $ca37bfd0324037b5$export$44abddc3fd19288a extends(0,$7VbkM$PassThrough){#errorOccured=false;#errorRegex=/^\s*not ok \d+ - /im;#endRegex=/^\d+\.\.\d+$/im;#buffer="";constructor(options={}){super(options)}get isValid(){return!this.#errorOccured}_transform(chunk,encoding,callback){const str=this._string(chunk);if(str.trim().length>0)this.emit("start");if(this.#errorRegex.test(str)){const oldFlag=this.#errorOccured;this.#errorOccured=true;if(this.#errorOccured!==oldFlag)this.emit("changed")}if(this.#endRegex.test(str))this.emit("end");super._transform(chunk,encoding,callback)}_string(chunk){const str=chunk.toString();const lastBreakLineIndex=str.lastIndexOf("\n");if(lastBreakLineIndex>=0){const lines=this.#buffer+str.slice(0,lastBreakLineIndex);this.#buffer=str.slice(lastBreakLineIndex);return lines}return this.#buffer+=str.slice(0)}}const $e1ffbe4efacf9784$export$7fd8d6ddb97d29fd=(emitter,event,timeout)=>{const positive=new Promise((resolve=>{emitter.once(event,resolve)}));const negative=(0,$7VbkM$scheduler).wait(timeout).then((()=>Promise.reject(new Error(`Timed out waiting for "${event}" event.`))));return Promise.race([positive,negative])};const{argv:$f7c04408f351be04$var$argv}=(0,$7VbkM$yargs)(process.argv.slice(2)).locale("en").option("defaults",{alias:"d",demandOption:false,describe:"Print default configuration values",boolean:true,nargs:0}).option("config",{alias:"c",demandOption:false,describe:"YAML configuration file path",string:"true",nargs:1,default:"config.yml"}).option("audio",{alias:"a",demandOption:false,describe:"Sound file path. Default is nyan cat song.",string:true,nargs:1}).option("silence",{alias:"s",demandOption:false,describe:"Do not play any sound.",boolean:true,nargs:0}).option("volume",{alias:"v",demandOption:false,describe:"Set percent value of sound volume in range [0-100]",number:true,nargs:1,default:100});const $f7c04408f351be04$var$volume=parseInt($f7c04408f351be04$var$argv.volume,10);if($f7c04408f351be04$var$volume<0||$f7c04408f351be04$var$volume>100){console.error(`Volume should be in range 0-100. Given value was ${$f7c04408f351be04$var$volume}.`);process.exit(2)}if($f7c04408f351be04$var$argv.defaults){console.log((0,$b5f246dd37abe703$export$a91807c918b9332e)());process.exit(0)}const $f7c04408f351be04$var$observer=new(0,$ca37bfd0324037b5$export$44abddc3fd19288a);(0,$7VbkM$pipeline)([process.stdin,$f7c04408f351be04$var$observer,process.stdout],(()=>{}));try{await(0,$e1ffbe4efacf9784$export$7fd8d6ddb97d29fd)($f7c04408f351be04$var$observer,"start",90)}catch(r){console.error("Empty input stream! A text stream formatted according to the Test Anything Protocol was expected.");process.exit(5)}const $f7c04408f351be04$var$controller=new AbortController;$f7c04408f351be04$var$observer.once("end",(()=>{$f7c04408f351be04$var$controller.abort();process.exit(0)}));if(!$f7c04408f351be04$var$argv.silence&&$f7c04408f351be04$var$volume>0){process.env.configFilePath=$f7c04408f351be04$var$argv.config;const player=new(0,$989b25cd83d9aade$export$832cc5475f11d8b4)($f7c04408f351be04$var$argv.audio,$f7c04408f351be04$var$volume,$f7c04408f351be04$var$controller.signal);player.connect($f7c04408f351be04$var$observer)}