#!/usr/bin/env node
import{pipeline as $dj3tT$pipeline,PassThrough as $dj3tT$PassThrough}from"stream";import $dj3tT$yargs from"yargs";import $dj3tT$assert from"assert";import{fork as $dj3tT$fork,ChildProcess as $dj3tT$ChildProcess}from"child_process";import{resolve as $dj3tT$resolve,join as $dj3tT$join,dirname as $dj3tT$dirname1}from"path";import{env as $dj3tT$env,cwd as $dj3tT$cwd,exit as $dj3tT$exit}from"process";import{dirname as $dj3tT$dirname}from"dirname-filename-esm";import{constants as $dj3tT$constants}from"fs";import $dj3tT$fspromises,{access as $dj3tT$access,readFile as $dj3tT$readFile}from"fs/promises";import{scheduler as $dj3tT$scheduler}from"timers/promises";import{isDeepStrictEqual as $dj3tT$isDeepStrictEqual}from"util";import $dj3tT$events from"events";import{mergeDeepRight as $dj3tT$mergeDeepRight}from"ramda";import $dj3tT$yaml from"yaml";const $0d5ddd1519aefed6$export$8c2dc7716bef61cc=obj=>Object.entries(Object.getOwnPropertyDescriptors(obj.__proto__)).filter((([name,item])=>typeof item.get==="function")).map((([name])=>name));const $755bef5bcb8e43db$var$sendObserverState=(observer,audio)=>audio.send({kind:"tap-stream-observer-state",value:JSON.stringify(observer,(0,$0d5ddd1519aefed6$export$8c2dc7716bef61cc)(observer))});const $755bef5bcb8e43db$export$7310cf3e5a42929c=(observer,audio)=>{$755bef5bcb8e43db$var$sendObserverState(observer,audio);observer.on("changed",(()=>$755bef5bcb8e43db$var$sendObserverState(observer,audio)))};const $4e84ae7309ae5ef7$export$842c7f1d8282385d=Object.seal({access:$dj3tT$access,readFile:$dj3tT$readFile});const $4e84ae7309ae5ef7$export$6a368473377ea45c=async()=>{const{access:access,readFile:readFile}=$4e84ae7309ae5ef7$export$842c7f1d8282385d;const parents=[];while(parents.length<4){const path=(0,$dj3tT$join)(...parents,"package.json");try{await access(path,(0,$dj3tT$constants).F_OK);const pkg=JSON.parse(await readFile(path,"utf8"));const expected="tap-ogg";if(pkg.name!==expected){parents.splice(0);parents.push("node_modules",expected);continue}return pkg}catch{parents.unshift("..")}}throw new Error(`Could not find package.json from CWD: ${(0,$dj3tT$cwd)()}`)};const $3224aff4755f5c4b$export$7fd8d6ddb97d29fd=(emitter,event,timeout)=>{const positive=new Promise((resolve=>{emitter.once(event,resolve)}));const negative=(0,$dj3tT$scheduler).wait(timeout).then((()=>Promise.reject(new Error(`Timed out waiting for "${event}" event.`))));return Promise.race([positive,negative])};var $60bddf0cac91bcea$import_meta=Object.assign(Object.create(null),{url:"file:///tap-ogg/build/src/audio/AudioPlayer.js"});const{name:$60bddf0cac91bcea$var$packageName}=await(0,$4e84ae7309ae5ef7$export$6a368473377ea45c)();const $60bddf0cac91bcea$var$dirPath=(0,$dj3tT$env).NODE_V8_COVERAGE&&(0,$dj3tT$env).npm_package_name===$60bddf0cac91bcea$var$packageName?"build/src/":(0,$dj3tT$dirname)($60bddf0cac91bcea$import_meta);class $60bddf0cac91bcea$export$832cc5475f11d8b4{#process;constructor(filePath,volume,abortSignal){if(!Number.isSafeInteger(volume))return;this.#process=(0,$dj3tT$fork)(this.modulePath,[filePath,`${volume}`],{env:{...process.env,PWD:(0,$dj3tT$resolve)(this.modulePath.split(`/${$60bddf0cac91bcea$var$packageName}/`)[0],$60bddf0cac91bcea$var$packageName),isAudioProcess:"true"},signal:abortSignal});this.#process.on("error",this.onError)}get modulePath(){const paths=[$60bddf0cac91bcea$var$dirPath.startsWith(`/${$60bddf0cac91bcea$var$packageName}/`)?`${(0,$dj3tT$cwd)().endsWith(`/${$60bddf0cac91bcea$var$packageName}`)?"":`../node_modules/${$60bddf0cac91bcea$var$packageName}/`}dist/`:$60bddf0cac91bcea$var$dirPath,"audio/play.js"];return(0,$dj3tT$resolve)((0,$dj3tT$cwd)(),...paths)}onError(err){const{code:code}=err;if(code!=="ABORT_ERR")console.error(err);if(code==="ENOENT")process.exit(8)}connect(observer){(0,$dj3tT$assert)(this.#process instanceof(0,$dj3tT$ChildProcess),`${this.#process} process should be ChildProcess instance`);(0,$755bef5bcb8e43db$export$7310cf3e5a42929c)(observer,this.#process)}}const $f350b95923ccbdb1$export$842c7f1d8282385d=Object.seal({exit:$dj3tT$exit,readFile:(0,$dj3tT$fspromises).readFile});const $f350b95923ccbdb1$var$defaultSettings=Object.freeze({effect:{echo:{enabled:true,size:8e3,gain:.85},tremolo:{enabled:true,lfo:{frequency:33,sampling:8e3}}}});const $f350b95923ccbdb1$export$b99b6f6e38298768=new(0,$dj3tT$events);const $f350b95923ccbdb1$var$watchFile=async()=>{const{configFilePath:configFilePath}=(0,$dj3tT$env);if(!configFilePath){console.error("wrong path from process:",process.argv);return}for await(const{filename:filename}of(0,$dj3tT$fspromises).watch((0,$dj3tT$dirname1)(configFilePath)))if(filename===configFilePath)$f350b95923ccbdb1$export$b99b6f6e38298768.emit("change")};if((0,$dj3tT$env).isAudioProcess)$f350b95923ccbdb1$var$watchFile();const $f350b95923ccbdb1$export$72c04af63de9061a=async()=>{const{configFilePath:configFilePath}=(0,$dj3tT$env);const{exit:exit,readFile:readFile}=$f350b95923ccbdb1$export$842c7f1d8282385d;try{const code=await readFile(configFilePath,"utf-8");if(code.trim()==="")return{};return(0,$dj3tT$yaml).parse(code)}catch(e){if(e.code!=="ENOENT"){console.error(e);exit(4)}return{}}};const $f350b95923ccbdb1$export$f2283db29a78ea0=async(file,state)=>(0,$dj3tT$mergeDeepRight)((0,$dj3tT$mergeDeepRight)($f350b95923ccbdb1$var$defaultSettings,await file()),state());const $f350b95923ccbdb1$export$a91807c918b9332e=()=>(0,$dj3tT$yaml).stringify($f350b95923ccbdb1$var$defaultSettings);const $d4f22d83f6d229a9$var$store={format:{sampleRate:44100}};const $d4f22d83f6d229a9$export$825f8f0ad33951e4=state=>{for(const key in state)$d4f22d83f6d229a9$var$store[key]=state[key]};const $d4f22d83f6d229a9$export$50fdfeece43146fd=()=>$d4f22d83f6d229a9$var$store;const $b46271c7a3404655$var$deliverConfiguration=()=>(0,$f350b95923ccbdb1$export$f2283db29a78ea0)((0,$f350b95923ccbdb1$export$72c04af63de9061a),(0,$d4f22d83f6d229a9$export$50fdfeece43146fd));const $b46271c7a3404655$export$842c7f1d8282385d={deliverConfiguration:$b46271c7a3404655$var$deliverConfiguration};const $b46271c7a3404655$var$cache=Object.seal({input:new Map,result:new Map});const $b46271c7a3404655$export$25a7e7a5abf9696a=async(name,selector,factory)=>{const{deliverConfiguration:deliverConfiguration}=$b46271c7a3404655$export$842c7f1d8282385d;const config=await deliverConfiguration();const data=selector(config);if($b46271c7a3404655$var$cache.input.has(name)&&(0,$dj3tT$isDeepStrictEqual)(data,$b46271c7a3404655$var$cache.input.get(name)))return $b46271c7a3404655$var$cache.result.get(name);const value=factory(data);$b46271c7a3404655$var$cache.input.set(name,data);$b46271c7a3404655$var$cache.result.set(name,value);return value};const $b46271c7a3404655$export$d2adf65b87e47523=()=>{for(const key in $b46271c7a3404655$var$cache){const map=$b46271c7a3404655$var$cache[key];map.clear()}};const $7314279b5fcbd88b$export$f416f9931619449a=Object.freeze({isValid:true});class $7314279b5fcbd88b$export$44abddc3fd19288a extends(0,$dj3tT$PassThrough){#errorOccured=false;#errorRegex=/^\s*not ok \d+ - /im;#endRegex=/^\d+\.\.\d+$/im;#buffer="";constructor(options={}){super(options)}get isValid(){return!this.#errorOccured}_transform(chunk,encoding,callback){const str=this._string(chunk);if(str.trim().length>0)this.emit("start");if(this.#errorRegex.test(str)){const oldFlag=this.#errorOccured;this.#errorOccured=true;if(this.#errorOccured!==oldFlag)this.emit("changed")}if(this.#endRegex.test(str))this.emit("end");super._transform(chunk,encoding,callback)}_string(chunk){const str=chunk.toString();const lastBreakLineIndex=str.lastIndexOf("\n");if(lastBreakLineIndex>=0){const lines=this.#buffer+str.slice(0,lastBreakLineIndex);this.#buffer=str.slice(lastBreakLineIndex);return lines}return this.#buffer+=str.slice(0)}}const{version:$7c10295496fc3dd7$var$version}=await(0,$4e84ae7309ae5ef7$export$6a368473377ea45c)();const{argv:$7c10295496fc3dd7$var$argv}=(0,$dj3tT$yargs)(process.argv.slice(2)).version($7c10295496fc3dd7$var$version).locale("en").option("defaults",{alias:"d",demandOption:false,describe:"Print default configuration values",boolean:true,nargs:0}).option("config",{alias:"c",demandOption:false,describe:"YAML configuration file path",string:"true",nargs:1,default:"config.yml"}).option("audio",{alias:"a",demandOption:false,describe:"Sound file path. Default is nyan cat song.",string:true,nargs:1}).option("silence",{alias:"s",demandOption:false,describe:"Do not play any sound.",boolean:true,nargs:0}).option("volume",{alias:"v",demandOption:false,describe:"Set percent value of sound volume in range [0-100]",number:true,nargs:1,default:100});const $7c10295496fc3dd7$var$volume=parseInt($7c10295496fc3dd7$var$argv.volume,10);if($7c10295496fc3dd7$var$volume<0||$7c10295496fc3dd7$var$volume>100){console.error(`Volume should be in range 0-100. Given value was ${$7c10295496fc3dd7$var$volume}.`);process.exit(2)}if($7c10295496fc3dd7$var$argv.defaults){console.log((0,$f350b95923ccbdb1$export$a91807c918b9332e)());process.exit(0)}const $7c10295496fc3dd7$var$observer=new(0,$7314279b5fcbd88b$export$44abddc3fd19288a);(0,$dj3tT$pipeline)([process.stdin,$7c10295496fc3dd7$var$observer,process.stdout],(()=>{}));try{await(0,$3224aff4755f5c4b$export$7fd8d6ddb97d29fd)($7c10295496fc3dd7$var$observer,"start",250)}catch(r){console.error("Empty input stream! A text stream formatted according to the Test Anything Protocol was expected.");process.exit(5)}const $7c10295496fc3dd7$var$controller=new AbortController;$7c10295496fc3dd7$var$observer.once("end",(()=>{$7c10295496fc3dd7$var$controller.abort();process.exit(0)}));if(!$7c10295496fc3dd7$var$argv.silence&&$7c10295496fc3dd7$var$volume>0){process.env.configFilePath=$7c10295496fc3dd7$var$argv.config;const player=new(0,$60bddf0cac91bcea$export$832cc5475f11d8b4)($7c10295496fc3dd7$var$argv.audio,$7c10295496fc3dd7$var$volume,$7c10295496fc3dd7$var$controller.signal);player.connect($7c10295496fc3dd7$var$observer)}