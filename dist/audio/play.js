import{createReadStream as $loaEA$createReadStream}from"fs";import{filename}from"dirname-filename-esm";import $loaEA$fspromises,{stat as $loaEA$stat}from"fs/promises";import $loaEA$path,{dirname as $loaEA$dirname1}from"path";import{argv as $loaEA$argv,cwd as $loaEA$cwd,env as $loaEA$env,exit as $loaEA$exit}from"process";import $loaEA$suldashiogg from"@suldashi/ogg";import $loaEA$tapoggvorbis from"@tap-ogg/vorbis";import{dirname as $loaEA$dirname}from"dirname-filename-esm";import{Transform as $loaEA$Transform,pipeline as $loaEA$pipeline,PassThrough as $loaEA$PassThrough}from"stream";import{takeCoverage as $loaEA$takeCoverage}from"v8";import{throttle as $loaEA$throttle}from"debouncing";import $loaEA$speaker from"speaker";import{isDeepStrictEqual as $loaEA$isDeepStrictEqual}from"util";import $loaEA$events from"events";import{mergeDeepRight as $loaEA$mergeDeepRight}from"ramda";import $loaEA$yaml from"yaml";import{Queue as $loaEA$Queue}from"@datastructures-js/queue";const $f350b95923ccbdb1$export$842c7f1d8282385d=Object.seal({exit:$loaEA$exit,readFile:(0,$loaEA$fspromises).readFile});const $f350b95923ccbdb1$var$defaultSettings=Object.freeze({effect:{echo:{enabled:true,size:8e3,gain:.85},tremolo:{enabled:true,lfo:{frequency:33,sampling:8e3}}}});const $f350b95923ccbdb1$export$b99b6f6e38298768=new(0,$loaEA$events);const $f350b95923ccbdb1$var$watchFile=async()=>{const{configFilePath:configFilePath}=(0,$loaEA$env);if(!configFilePath){console.error("wrong path from process:",process.argv);return}for await(const{filename:filename}of(0,$loaEA$fspromises).watch((0,$loaEA$dirname1)(configFilePath)))if(filename===configFilePath)$f350b95923ccbdb1$export$b99b6f6e38298768.emit("change")};if((0,$loaEA$env).isAudioProcess)$f350b95923ccbdb1$var$watchFile();const $f350b95923ccbdb1$export$72c04af63de9061a=async()=>{const{configFilePath:configFilePath}=(0,$loaEA$env);const{exit:exit,readFile:readFile}=$f350b95923ccbdb1$export$842c7f1d8282385d;try{const code=await readFile(configFilePath,"utf-8");if(code.trim()==="")return{};return(0,$loaEA$yaml).parse(code)}catch(e){if(e.code!=="ENOENT"){console.error(e);exit(4)}return{}}};const $f350b95923ccbdb1$export$f2283db29a78ea0=async(file,state)=>(0,$loaEA$mergeDeepRight)((0,$loaEA$mergeDeepRight)($f350b95923ccbdb1$var$defaultSettings,await file()),state());const $f350b95923ccbdb1$export$a91807c918b9332e=()=>(0,$loaEA$yaml).stringify($f350b95923ccbdb1$var$defaultSettings);const $d4f22d83f6d229a9$var$store={format:{sampleRate:44100}};const $d4f22d83f6d229a9$export$825f8f0ad33951e4=state=>{for(const key in state)$d4f22d83f6d229a9$var$store[key]=state[key]};const $d4f22d83f6d229a9$export$50fdfeece43146fd=()=>$d4f22d83f6d229a9$var$store;const $b46271c7a3404655$var$deliverConfiguration=()=>(0,$f350b95923ccbdb1$export$f2283db29a78ea0)((0,$f350b95923ccbdb1$export$72c04af63de9061a),(0,$d4f22d83f6d229a9$export$50fdfeece43146fd));const $b46271c7a3404655$export$842c7f1d8282385d={deliverConfiguration:$b46271c7a3404655$var$deliverConfiguration};const $b46271c7a3404655$var$cache=Object.seal({input:new Map,result:new Map});const $b46271c7a3404655$export$25a7e7a5abf9696a=async(name,selector,factory)=>{const{deliverConfiguration:deliverConfiguration}=$b46271c7a3404655$export$842c7f1d8282385d;const config=await deliverConfiguration();const data=selector(config);if($b46271c7a3404655$var$cache.input.has(name)&&(0,$loaEA$isDeepStrictEqual)(data,$b46271c7a3404655$var$cache.input.get(name)))return $b46271c7a3404655$var$cache.result.get(name);const value=factory(data);$b46271c7a3404655$var$cache.input.set(name,data);$b46271c7a3404655$var$cache.result.set(name,value);return value};const $b46271c7a3404655$export$d2adf65b87e47523=()=>{for(const key in $b46271c7a3404655$var$cache){const map=$b46271c7a3404655$var$cache[key];map.clear()}};const $34363ca4c26fd612$export$822607f76a6b1170=({bitDepth:bitDepth,float:float,signed:signed})=>{if(float){if(signed)switch(bitDepth){case 32:return Float32Array;case 64:return Float64Array;default:throw new Error("Unsupported float bit depth!")}}if(signed)switch(bitDepth){case 8:return Int8Array;case 16:return Int16Array;case 32:return Int32Array;case 64:return BigInt64Array;default:throw new Error("Unsupported signed integer bit depth!")}switch(bitDepth){case 8:return Uint8Array;case 16:return Uint16Array;case 32:return Uint32Array;case 64:return BigUint64Array;default:throw new Error("Unsupported unsigned integer bit depth!")}};const $7314279b5fcbd88b$export$f416f9931619449a=Object.freeze({isValid:true});class $7314279b5fcbd88b$export$44abddc3fd19288a extends(0,$loaEA$PassThrough){#errorOccured=false;#errorRegex=/^\s*not ok \d+ - /im;#endRegex=/^\d+\.\.\d+$/im;#buffer="";constructor(options={}){super(options)}get isValid(){return!this.#errorOccured}_transform(chunk,encoding,callback){const str=this._string(chunk);if(str.trim().length>0)this.emit("start");if(this.#errorRegex.test(str)){const oldFlag=this.#errorOccured;this.#errorOccured=true;if(this.#errorOccured!==oldFlag)this.emit("changed")}if(this.#endRegex.test(str))this.emit("end");super._transform(chunk,encoding,callback)}_string(chunk){const str=chunk.toString();const lastBreakLineIndex=str.lastIndexOf("\n");if(lastBreakLineIndex>=0){const lines=this.#buffer+str.slice(0,lastBreakLineIndex);this.#buffer=str.slice(lastBreakLineIndex);return lines}return this.#buffer+=str.slice(0)}}const $d634863b7f9608ee$var$config={observer:(0,$7314279b5fcbd88b$export$f416f9931619449a),process:process,watcher:(0,$f350b95923ccbdb1$export$b99b6f6e38298768)};class $d634863b7f9608ee$export$a32b0b1c1ac59d04{enabled;observer;watcher;process;get observerState(){return this.observer}constructor(cfg=$d634863b7f9608ee$var$config){this.enabled=false;this.observer=cfg.observer;this.watcher=cfg.watcher;this.watcher.on("change",this.setup.bind(this));this.process=cfg.process;this.process.on("message",(({kind:kind,value:value})=>{switch(kind){case"tap-stream-observer-state":this.observer=JSON.parse(value);break;default:break}}))}mix(a,b){return a+b-a*b}get isDisabled(){return!this.enabled||this.observer.isValid}effect({ChunkBuffer:ChunkBuffer}){return new(0,$loaEA$Transform)({transform:(chunk,encoding,callback)=>{if(this.isDisabled){callback(null,chunk);return}const array=new ChunkBuffer(chunk.buffer);callback(null,new Uint8Array(array.map(this.sampleMapper.bind(this)).buffer))}})}}const $d634863b7f9608ee$export$f66d476873aa7f00=v=>v;const $dac2e8c76bce0e41$export$842c7f1d8282385d=Object.seal({deliver:$b46271c7a3404655$export$25a7e7a5abf9696a});const $dac2e8c76bce0e41$var$echoSelector=({effect:{echo:{enabled:enabled,gain:gain,size:size}}})=>({enabled:enabled,gain:gain,size:size});class $dac2e8c76bce0e41$export$95f5f2a91e6b436d extends(0,$d634863b7f9608ee$export$a32b0b1c1ac59d04){gain;queue;async setup(){const{deliver:deliver}=$dac2e8c76bce0e41$export$842c7f1d8282385d;const{enabled:enabled,gain:gain,size:size}=await deliver("effect.echo",$dac2e8c76bce0e41$var$echoSelector,(0,$d634863b7f9608ee$export$f66d476873aa7f00));this.enabled=enabled;this.gain=gain;this.queue=new(0,$loaEA$Queue)(new Array(size).fill(1))}sampleMapper(sample){const value=this.queue.dequeue();this.queue.enqueue(sample);return this.mix(sample,value*this.gain)}}const $dac2e8c76bce0e41$export$d6d05aea2a3e8977=async deps=>{const instance=new $dac2e8c76bce0e41$export$95f5f2a91e6b436d;await instance.setup();return instance.effect(deps)};const $6ea15dd577a762b0$export$173bbe91bb23610=({sampling:sampling,frequency:frequency,number:number})=>2*number*frequency*Math.PI/sampling;class $6ea15dd577a762b0$export$230d30512a20bd9b{#sampling=44100;#frequency=20;constructor({sampling:sampling,frequency:frequency}){this.#sampling=sampling;this.#frequency=frequency}at(n){return Math.sin($6ea15dd577a762b0$export$173bbe91bb23610({sampling:this.#sampling,frequency:this.#frequency,number:n}))}}const $f440337c5437a79c$export$842c7f1d8282385d=Object.seal({deliver:$b46271c7a3404655$export$25a7e7a5abf9696a});const $f440337c5437a79c$export$fb8d7aff166c482=({effect:{tremolo:{lfo:lfo}},format:format})=>{if(!Object.hasOwn(lfo,"frequency"))throw new RangeError("frequency must be configured in tremolo effect");var _format_sampleRate;const sampling=(_format_sampleRate=format===null||format===void 0?void 0:format.sampleRate)!==null&&_format_sampleRate!==void 0?_format_sampleRate:lfo.sampling;return{...lfo,sampling:sampling}};const $f440337c5437a79c$export$c86e31794080fa42=({frequency:frequency,sampling:sampling})=>new(0,$6ea15dd577a762b0$export$230d30512a20bd9b)({sampling:sampling,frequency:frequency});const $f440337c5437a79c$export$a55a9e806096b2f=({effect:{tremolo:{enabled:enabled}}})=>enabled;class $f440337c5437a79c$export$973d64996e3474e3 extends(0,$d634863b7f9608ee$export$a32b0b1c1ac59d04){n=0;lfo;async setup(){const{deliver:deliver}=$f440337c5437a79c$export$842c7f1d8282385d;this.lfo=await deliver("LowFrequencyOscilator",$f440337c5437a79c$export$fb8d7aff166c482,$f440337c5437a79c$export$c86e31794080fa42);this.enabled=await deliver("effect.tremolo.enabled",$f440337c5437a79c$export$a55a9e806096b2f,(0,$d634863b7f9608ee$export$f66d476873aa7f00))}sampleMapper(input){return this.mix(input,this.lfo.at(this.n++))}}const $f440337c5437a79c$export$3e98c3c57367b836=async deps=>{const instance=new $f440337c5437a79c$export$973d64996e3474e3;await instance.setup();return instance.effect(deps)};const $84ff3336f277b591$var$volume=({ChunkBuffer:ChunkBuffer,level:level})=>new(0,$loaEA$Transform)({transform:(chunk,encoding,callback)=>{const array=new ChunkBuffer(chunk.buffer);callback(null,new Uint8Array(array.map((sample=>sample*level)).buffer))}});const $84ff3336f277b591$var$flushCoverage=(0,$loaEA$throttle)((0,$loaEA$takeCoverage),120);const $84ff3336f277b591$var$coverage=(0,$loaEA$env).NODE_V8_COVERAGE?new(0,$loaEA$Transform)({transform:(chunk,_,callback)=>{callback(null,chunk);$84ff3336f277b591$var$flushCoverage()}}):null;const $84ff3336f277b591$export$30f9dba7b373edd4=async(input,format,volumeLevel)=>{(0,$d4f22d83f6d229a9$export$825f8f0ad33951e4)({format:format});const ChunkBuffer=(0,$34363ca4c26fd612$export$822607f76a6b1170)(format);const deps={ChunkBuffer:ChunkBuffer};const sequence=[input];if($84ff3336f277b591$var$coverage)sequence.push($84ff3336f277b591$var$coverage);if(volumeLevel<1)sequence.push($84ff3336f277b591$var$volume({...deps,level:volumeLevel}));sequence.push(await(0,$dac2e8c76bce0e41$export$d6d05aea2a3e8977)(deps),await(0,$f440337c5437a79c$export$3e98c3c57367b836)(deps),new(0,$loaEA$speaker)(format));return(0,$loaEA$pipeline)(sequence,(()=>{}))};var $d61e9d4ed14c263c$import_meta=Object.assign(Object.create(null),{url:"file:///tap-ogg/build/src/audio/play.js"});const $d61e9d4ed14c263c$var$volumeLevel=parseInt((0,$loaEA$argv)[3],10)/100;function $d61e9d4ed14c263c$var$play(file){const decoder=new(0,$loaEA$suldashiogg).Decoder;decoder.on("stream",(stream=>{const vd=new(0,$loaEA$tapoggvorbis).Decoder;vd.on("format",(async format=>{await(0,$84ff3336f277b591$export$30f9dba7b373edd4)(vd,format,$d61e9d4ed14c263c$var$volumeLevel)}));stream.pipe(vd);stream.on("end",(()=>{$d61e9d4ed14c263c$var$play(file)}))}));decoder.on("error",(err=>{console.log({err:err})}));decoder.on("close",(()=>{console.log("on close")}));(0,$loaEA$createReadStream)(file).pipe(decoder)}const $d61e9d4ed14c263c$var$filePath=async file=>{if(file&&file!=="undefined"){const fp=(0,$loaEA$path).resolve((0,$loaEA$cwd)(),file);const info=await(0,$loaEA$stat)(fp);if(info.isFile())return fp}return(0,$loaEA$path).resolve((0,$loaEA$dirname)($d61e9d4ed14c263c$import_meta),"../sound/nyan.ogg")};$d61e9d4ed14c263c$var$play(await $d61e9d4ed14c263c$var$filePath((0,$loaEA$argv)[2]));